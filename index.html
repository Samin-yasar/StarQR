<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZK Scanner - Zero Knowledge QR/Barcode Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root {
          --azure-primary: #0078d4;
          --azure-primary-dark: #106ebe;
          --azure-primary-light: #40e0ff;
          --azure-secondary: #00bcf2;
          --azure-accent: #0099bc;
          --azure-success: #107c10;
          --azure-warning: #ffb900;
          --azure-error: #d13438;
          --azure-bg: #f8f9fa;
          --azure-surface: #ffffff;
          --azure-surface-alt: #faf9f8;
          --azure-border: #edebe9;
          --azure-text: #323130;
          --azure-text-secondary: #605e5c;
          --azure-shadow: rgba(0, 0, 0, 0.1);
          --azure-shadow-heavy: rgba(0, 0, 0, 0.2);
        }

        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', sans-serif;
          background: linear-gradient(135deg, var(--azure-bg) 0%, #e1f5fe 100%);
          color: var(--azure-text);
          line-height: 1.6;
          min-height: 100vh;
          padding: 20px;
        }

        /* Header Styles */
        h1 {
          color: var(--azure-primary);
          font-size: 2.5rem;
          font-weight: 600;
          margin-bottom: 0.5rem;
          text-align: center;
          background: linear-gradient(45deg, var(--azure-primary), var(--azure-secondary));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }

        body > p {
          text-align: center;
          color: var(--azure-text-secondary);
          margin-bottom: 2rem;
          font-size: 1.1rem;
        }

        h2 {
          color: var(--azure-primary);
          font-size: 1.5rem;
          margin-bottom: 1rem;
          border-bottom: 2px solid var(--azure-primary);
          padding-bottom: 0.5rem;
        }

        h3 {
          color: var(--azure-accent);
          font-size: 1.2rem;
          margin-bottom: 0.5rem;
        }

        /* Section Containers */
        #scanner-section,
        #history-section,
        #stats-section {
          background: var(--azure-surface);
          border-radius: 12px;
          padding: 2rem;
          margin-bottom: 2rem;
          box-shadow: 0 4px 12px var(--azure-shadow);
          border: 1px solid var(--azure-border);
          backdrop-filter: blur(10px);
        }
        
        #scanner-section video {
            width: 600px; /* Increased width */
            height: 450px; /* Increased height */
            border: 2px solid #000; /* Optional: adds a border for visibility */
        }

        /* Button Styles */
        button {
          background: linear-gradient(135deg, var(--azure-primary), var(--azure-primary-dark));
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 8px;
          font-size: 0.95rem;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.3s ease;
          margin: 0.25rem;
          box-shadow: 0 2px 8px rgba(0, 120, 212, 0.3);
        }

        button:hover {
          background: linear-gradient(135deg, var(--azure-primary-dark), var(--azure-accent));
          transform: translateY(-2px);
          box-shadow: 0 4px 16px rgba(0, 120, 212, 0.4);
        }

        button:active {
          transform: translateY(0);
          box-shadow: 0 2px 8px rgba(0, 120, 212, 0.3);
        }

        button:disabled {
          background: #ccc;
          cursor: not-allowed;
          transform: none;
          box-shadow: none;
        }

        /* Special button variants */
        .delete-btn {
          background: linear-gradient(135deg, var(--azure-error), #b71c1c);
          font-size: 0.8rem;
          padding: 6px 12px;
        }

        .copy-btn {
          background: linear-gradient(135deg, var(--azure-success), #2e7d32);
          font-size: 0.8rem;
          padding: 6px 12px;
        }

        #clear-history {
          background: linear-gradient(135deg, var(--azure-warning), #f57f17);
        }

        /* Input Styles */
        input[type="text"],
        select {
          padding: 12px 16px;
          border: 2px solid var(--azure-border);
          border-radius: 8px;
          font-size: 1rem;
          background: var(--azure-surface);
          color: var(--azure-text);
          transition: all 0.3s ease;
          margin: 0.25rem;
        }

        input[type="text"]:focus,
        select:focus {
          outline: none;
          border-color: var(--azure-primary);
          box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
        }

        #search-filter {
          display: flex;
          gap: 1rem;
          margin-bottom: 1.5rem;
          flex-wrap: wrap;
          align-items: center;
        }

        #search-input {
          flex: 1;
          min-width: 200px;
        }

        /* Scanner Container */
        #qr-reader {
          width: 100%;
          max-width: 500px;
          margin: 2rem auto;
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 4px 12px var(--azure-shadow);
        }

        #scanner-container {
          text-align: center;
          margin: 2rem 0;
          padding: 2rem;
          background: var(--azure-surface-alt);
          border-radius: 12px;
          border: 2px dashed var(--azure-primary);
        }

        /* Result Display */
        #result {
          background: linear-gradient(135deg, var(--azure-surface-alt), #e3f2fd);
          padding: 1.5rem;
          border-radius: 8px;
          margin-top: 1rem;
          border-left: 4px solid var(--azure-primary);
        }

        #scan-result {
          font-family: 'Consolas', 'Monaco', monospace;
          background: var(--azure-surface);
          padding: 1rem;
          border-radius: 6px;
          border: 1px solid var(--azure-border);
          word-break: break-all;
          font-size: 0.95rem;
          color: var(--azure-text);
        }

        /* History List */
        #history-list {
          max-height: 400px;
          overflow-y: auto;
          background: var(--azure-surface-alt);
          border-radius: 8px;
          padding: 1rem;
        }

        .scan-item {
          background: var(--azure-surface);
          padding: 1rem;
          margin-bottom: 1rem;
          border-radius: 8px;
          border-left: 4px solid var(--azure-secondary);
          box-shadow: 0 2px 8px var(--azure-shadow);
          transition: all 0.3s ease;
        }

        .scan-item:hover {
          transform: translateX(4px);
          box-shadow: 0 4px 16px var(--azure-shadow);
        }

        .scan-item strong {
          color: var(--azure-primary);
          font-weight: 600;
        }

        .scan-item small {
          color: var(--azure-text-secondary);
          font-size: 0.85rem;
        }

        /* Statistics Display */
        #stats-display {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1rem;
          margin-top: 1rem;
        }

        .stat-card {
          background: linear-gradient(135deg, var(--azure-primary-light), var(--azure-secondary));
          color: white;
          padding: 1.5rem;
          border-radius: 8px;
          text-align: center;
          font-size: 1.1rem;
          font-weight: 500;
          box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
          body {
            padding: 10px;
          }
          
          h1 {
            font-size: 2rem;
          }
          
          #scanner-section,
          #history-section,
          #stats-section {
            padding: 1.5rem;
          }
          
          #search-filter {
            flex-direction: column;
            align-items: stretch;
          }
          
          #search-input,
          select {
            width: 100%;
            margin: 0.25rem 0;
          }
          
          button {
            width: 100%;
            margin: 0.25rem 0;
          }
          
          .scan-item button {
            width: auto;
            margin: 0.25rem;
          }
        }

        /* Animations */
        @keyframes fadeInOut {
          0% { opacity: 0; transform: translateY(-10px); }
          20% { opacity: 1; transform: translateY(0); }
          80% { opacity: 1; transform: translateY(0); }
          100% { opacity: 0; transform: translateY(-10px); }
        }

        /* Focus and Accessibility */
        button:focus,
        input:focus,
        select:focus {
          outline: 2px solid var(--azure-primary);
          outline-offset: 2px;
        }

        /* Scrollbar Styling */
        #history-list::-webkit-scrollbar {
          width: 8px;
        }

        #history-list::-webkit-scrollbar-track {
          background: var(--azure-border);
          border-radius: 4px;
        }

        #history-list::-webkit-scrollbar-thumb {
          background: var(--azure-primary);
          border-radius: 4px;
        }

        #history-list::-webkit-scrollbar-thumb:hover {
          background: var(--azure-primary-dark);
        }
    </style>
</head>
<body>
    <h1>Zero-Knowledge QR/Barcode Scanner</h1>
    <p>All data is stored locally in your browser. Nothing is sent to any server.</p>

    <!-- Scanner Section -->
    <div id="scanner-section">
        <h2>Scanner</h2>
        <div class="controls">
            <button id="start-camera">Start Camera</button>
            <button id="stop-camera" disabled>Stop Camera</button>
            <button id="upload-image">Upload Image</button>
            <input type="file" id="file-input" accept="image/*" style="display:none;">
        </div>
        <p>Use your camera or upload an image to scan QR codes and barcodes.</p>
        
        <div id="scanner-container">
            <div id="qr-reader"></div>
        </div>
        
        <div id="result">
            <h3>Last Scan Result:</h3>
            <p id="scan-result">No scan yet</p>
        </div>
    </div>

    <!-- History Section -->
    <div id="history-section">
        <h2>Scan History</h2>
        <div class="controls">
            <button id="export-data">Export Data</button>
            <button id="import-data">Import Data</button>
            <input type="file" id="import-input" accept=".json" style="display:none;">
            <button id="clear-history">Clear All History</button>
        </div>
        
        <div id="search-filter">
            <input type="text" id="search-input" placeholder="Search scans...">
            <select id="type-filter">
                <option value="">All Types</option>
                <option value="QR">QR Codes</option>
                <option value="Barcode">Barcodes</option>
            </select>
        </div>
        
        <div id="history-list"></div>
    </div>

    <!-- Statistics -->
    <div id="stats-section">
        <h2>Statistics</h2>
        <div id="stats-display"></div>
    </div>

    <script>
        // Scanner Database Management (using in-memory storage for Claude.ai compatibility)
        class ScannerDB {
            constructor() {
                this.scans = [];
                this.nextId = 1;
            }

            async init() {
                // Initialize with empty array - no IndexedDB in Claude.ai
                return Promise.resolve();
            }

            async addScan(data, type) {
                const scan = {
                    id: this.nextId++,
                    data: data,
                    type: type,
                    timestamp: new Date().toISOString()
                };
                
                this.scans.push(scan);
                return Promise.resolve(scan);
            }

            async getAllScans() {
                return Promise.resolve([...this.scans]);
            }

            async deleteScan(id) {
                this.scans = this.scans.filter(scan => scan.id !== id);
                return Promise.resolve();
            }

            async clearAll() {
                this.scans = [];
                this.nextId = 1;
                return Promise.resolve();
            }

            async exportData() {
                return Promise.resolve(JSON.stringify(this.scans, null, 2));
            }

            async importData(jsonData) {
                try {
                    const data = JSON.parse(jsonData);
                    if (Array.isArray(data)) {
                        // Add imported scans with new IDs
                        for (const scan of data) {
                            await this.addScan(scan.data, scan.type);
                        }
                    }
                    return Promise.resolve();
                } catch (error) {
                    return Promise.reject(error);
                }
            }
        }

        // Scanner App using html5-qrcode
        class ZKScanner {
            constructor() {
                this.db = new ScannerDB();
                this.html5QrCode = null;
                this.isScanning = false;
                this.allScans = [];
                
                this.init();
            }

            async init() {
                await this.db.init();
                this.setupEventListeners();
                this.updateHistory();
                this.updateStats();
                
                // Initialize html5-qrcode scanner
                this.html5QrCode = new Html5Qrcode("qr-reader");
            }

            setupEventListeners() {
                document.getElementById('start-camera').addEventListener('click', () => this.startCamera());
                document.getElementById('stop-camera').addEventListener('click', () => this.stopCamera());
                document.getElementById('upload-image').addEventListener('click', () => document.getElementById('file-input').click());
                document.getElementById('file-input').addEventListener('change', (e) => this.handleFileUpload(e));
                
                document.getElementById('export-data').addEventListener('click', () => this.exportData());
                document.getElementById('import-data').addEventListener('click', () => document.getElementById('import-input').click());
                document.getElementById('import-input').addEventListener('change', (e) => this.handleImport(e));
                document.getElementById('clear-history').addEventListener('click', () => this.clearHistory());
                
                document.getElementById('search-input').addEventListener('input', () => this.filterHistory());
                document.getElementById('type-filter').addEventListener('change', () => this.filterHistory());
            }

            async startCamera() {
                if (this.isScanning) return;

                try {
                    const config = {
                        fps: 10,
                        qrbox: { width: 350, height: 350 },
                        aspectRatio: 1.0,
                        formatsToSupport: [
                            Html5QrcodeSupportedFormats.QR_CODE,
                            Html5QrcodeSupportedFormats.UPC_A,
                            Html5QrcodeSupportedFormats.UPC_E,
                            Html5QrcodeSupportedFormats.EAN_13,
                            Html5QrcodeSupportedFormats.EAN_8,
                            Html5QrcodeSupportedFormats.CODE_128,
                            Html5QrcodeSupportedFormats.CODE_39,
                            Html5QrcodeSupportedFormats.CODE_93,
                            Html5QrcodeSupportedFormats.CODABAR
                        ]
                    };

                    await this.html5QrCode.start(
                        { facingMode: "environment" },
                        config,
                        (decodedText, decodedResult) => {
                            this.handleScanResult(decodedText, this.getCodeType(decodedResult));
                        },
                        (errorMessage) => {
                            // Handle scan errors silently - this fires continuously
                        }
                    );

                    this.isScanning = true;
                    document.getElementById('start-camera').disabled = true;
                    document.getElementById('stop-camera').disabled = false;
                    
                } catch (error) {
                    console.error('Camera start error:', error);
                    alert('Failed to start camera: ' + error.message);
                }
            }

            async stopCamera() {
                if (!this.isScanning) return;

                try {
                    await this.html5QrCode.stop();
                    this.isScanning = false;
                    document.getElementById('start-camera').disabled = false;
                    document.getElementById('stop-camera').disabled = true;
                } catch (error) {
                    console.error('Camera stop error:', error);
                }
            }

            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const result = await this.html5QrCode.scanFile(file, true);
                    this.handleScanResult(result, 'QR/Barcode');
                } catch (error) {
                    console.error('File scan error:', error);
                    alert('No QR code or barcode detected in the image');
                }
                
                // Clear the file input
                event.target.value = '';
            }

            getCodeType(decodedResult) {
                if (decodedResult && decodedResult.result && decodedResult.result.format) {
                    const format = decodedResult.result.format.formatName;
                    if (format === 'QR_CODE') {
                        return 'QR Code';
                    } else {
                        return 'Barcode';
                    }
                }
                return 'QR/Barcode';
            }

            async handleScanResult(data, type) {
                // Show result
                document.getElementById('scan-result').textContent = `${type}: ${data}`;
                
                // Add to database
                await this.db.addScan(data, type);
                
                // Update UI
                this.updateHistory();
                this.updateStats();
                
                // Auto-stop camera after successful scan
                if (this.isScanning) {
                    await this.stopCamera();
                }
                
                // Show success feedback
                this.showSuccessFeedback();
            }

            showSuccessFeedback() {
                const result = document.getElementById('scan-result');
                result.style.background = '#d4edda';
                result.style.color = '#155724';
                result.style.padding = '10px';
                result.style.borderRadius = '5px';
                result.style.border = '1px solid #c3e6cb';
                
                setTimeout(() => {
                    result.style.background = '';
                    result.style.color = '';
                    result.style.padding = '';
                    result.style.borderRadius = '';
                    result.style.border = '';
                }, 3000);
            }

            async updateHistory() {
                const scans = await this.db.getAllScans();
                scans.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                this.allScans = scans;
                this.filterHistory();
            }

            filterHistory() {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const typeFilter = document.getElementById('type-filter').value;
                
                let filtered = this.allScans || [];
                
                if (searchTerm) {
                    filtered = filtered.filter(scan => 
                        scan.data.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (typeFilter) {
                    filtered = filtered.filter(scan => scan.type.includes(typeFilter));
                }
                
                this.renderHistory(filtered);
            }

            renderHistory(scans) {
                const historyList = document.getElementById('history-list');
                
                if (scans.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No scans found</p>';
                    return;
                }
                
                historyList.innerHTML = scans.map(scan => `
                    <div class="scan-item">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                            <div style="flex: 1;">
                                <strong>${scan.type}</strong>
                                <div style="margin: 5px 0; word-break: break-all; font-family: monospace; background: white; padding: 8px; border-radius: 4px;">
                                    ${this.escapeHtml(scan.data)}
                                </div>
                                <small>${new Date(scan.timestamp).toLocaleString()}</small>
                            </div>
                            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                <button onclick="scanner.copyScan('${this.escapeHtml(scan.data)}')" class="copy-btn">
                                    Copy
                                </button>
                                <button onclick="scanner.deleteScan(${scan.id})" class="delete-btn">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            async deleteScan(id) {
                if (confirm('Delete this scan?')) {
                    await this.db.deleteScan(id);
                    this.updateHistory();
                    this.updateStats();
                }
            }

            async copyScan(data) {
                try {
                    await navigator.clipboard.writeText(data);
                    this.showCopyFeedback();
                } catch (error) {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = data;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showCopyFeedback();
                }
            }

            showCopyFeedback() {
                const feedback = document.createElement('div');
                feedback.textContent = 'Copied to clipboard!';
                feedback.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 5px;
                    z-index: 1000;
                    animation: fadeInOut 2s ease-in-out;
                `;
                
                document.body.appendChild(feedback);
                setTimeout(() => document.body.removeChild(feedback), 2000);
            }

            async updateStats() {
                const scans = await this.db.getAllScans();
                const qrCount = scans.filter(s => s.type.includes('QR')).length;
                const barcodeCount = scans.filter(s => s.type.includes('Barcode')).length;
                
                document.getElementById('stats-display').innerHTML = `
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--azure-primary), var(--azure-primary-dark));">
                        <div style="font-size: 24px; font-weight: bold;">${scans.length}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Total Scans</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--azure-success), #2e7d32);">
                        <div style="font-size: 24px; font-weight: bold;">${qrCount}</div>
                        <div style="font-size: 12px; opacity: 0.9;">QR Codes</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--azure-warning), #f57f17);">
                        <div style="font-size: 24px; font-weight: bold;">${barcodeCount}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Barcodes</div>
                    </div>
                `;
            }

            async exportData() {
                const data = await this.db.exportData();
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `zk-scanner-export-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
            }

            async handleImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        await this.db.importData(e.target.result);
                        this.updateHistory();
                        this.updateStats();
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Failed to import data: ' + error.message);
                    }
                };
                reader.readAsText(file);
                
                // Clear the file input
                event.target.value = '';
            }

            async clearHistory() {
                if (confirm('Are you sure you want to clear all scan history? This cannot be undone.')) {
                    await this.db.clearAll();
                    this.updateHistory();
                    this.updateStats();
                }
            }
        }

        // Initialize the scanner app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Check if html5-qrcode library is loaded
            if (typeof Html5Qrcode === 'undefined') {
                alert('html5-qrcode library is not loaded. Please include the library script.');
                return;
            }
            
            // Initialize scanner
            window.scanner = new ZKScanner();
        });
    </script>
</body>
</html>